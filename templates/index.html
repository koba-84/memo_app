<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>メモ一覧</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .tag {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      margin: 2px;
      color: white;
      display: inline-block;
    }
  </style>
</head>
<body>
  <div class="container py-4">
    <h2 class="mb-3">メモを追加</h2>
    <form id="memo-form" class="mb-4">
      <div class="mb-3">
        <input type="text" name="title" class="form-control" placeholder="タイトル" required>
      </div>
      <div class="mb-3">
        <textarea name="content" rows="5" class="form-control" placeholder="内容" required></textarea>
      </div>
      <div class="mb-3">
        <input type="text" name="tags" class="form-control" placeholder="タグ（カンマ区切り）">
      </div>
      <button type="submit" class="btn btn-primary">追加</button>
    </form>

    <hr>

    <div class="input-group mb-4">
      <input type="text" id="search" class="form-control" placeholder="検索ワードを入力">
      <button id="search-btn" class="btn btn-outline-secondary">検索</button>
    </div>

    <h2>メモ一覧</h2>
    <div id="memo-list" class="row row-cols-1 row-cols-md-2 g-4"></div>
  </div>

  <script>
    const tagColors = {};
    const colorList = [
      "#f44336", "#e91e63", "#9c27b0", "#3f51b5", "#03a9f4",
      "#009688", "#4caf50", "#8bc34a", "#ff9800", "#795548"
    ];

    function getTagColor(tagName) {
      if (!tagColors[tagName]) {
        const usedColors = Object.values(tagColors);
        const availableColors = colorList.filter(c => !usedColors.includes(c));
        tagColors[tagName] = availableColors.length > 0
          ? availableColors[Math.floor(Math.random() * availableColors.length)]
          : colorList[Math.floor(Math.random() * colorList.length)];
      }
      return tagColors[tagName];
    }

    async function fetchMemos(query = "") {
      const token = localStorage.getItem("token");
      const res = await fetch(`/api/memos${query ? "?q=" + encodeURIComponent(query) : ""}`, {
        headers: { Authorization: `Bearer ${token}` }
      });

      const container = document.getElementById("memo-list");
      container.innerHTML = "";

      if (res.ok) {
        const memos = await res.json();
        memos.forEach(memo => {
          const tagsHtml = memo.tags?.length
            ? memo.tags.map(t => `<span class="tag badge" style="background-color: ${getTagColor(t)}">${t}</span>`).join(" ")
            : "";

          const div = document.createElement("div");
          div.className = "col";
          div.innerHTML = `
            <div class="card h-100">
              <div class="card-body">
                <h5 class="card-title">${memo.title}</h5>
                <p class="card-text">${memo.content}</p>
                <div>${tagsHtml}</div>
              </div>
              <div class="card-footer d-flex justify-content-between align-items-center">
                <small class="text-muted">${new Date(memo.created_at).toLocaleString()}</small>
                <button class="btn btn-sm btn-danger" onclick="deleteMemo(${memo.id})">削除</button>
              </div>
            </div>
          `;
          container.appendChild(div);
        });
      } else {
        alert("メモ取得に失敗しました。再ログインしてください。");
        location.href = "/login";
      }
    }

    document.getElementById("memo-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const form = e.target;
      const token = localStorage.getItem("token");

      const res = await fetch("/api/memos", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`
        },
        body: JSON.stringify({
          title: form.title.value,
          content: form.content.value,
          tags: form.tags.value.split(",").map(t => t.trim()).filter(Boolean),
          user_id: parseInt(localStorage.getItem("user_id"))
        })
      });

      if (res.ok) {
        alert("メモ追加成功");
        form.reset();
        fetchMemos();
      } else {
        alert("メモ追加に失敗しました");
      }
    });

    function deleteMemo(id) {
      const token = localStorage.getItem("token");
      fetch(`/api/memos/${id}`, {
        method: "DELETE",
        headers: { Authorization: `Bearer ${token}` }
      }).then(res => {
        if (res.ok) {
          fetchMemos();
        } else {
          alert("削除に失敗しました");
        }
      });
    }

    document.getElementById("search-btn").addEventListener("click", () => {
      const q = document.getElementById("search").value;
      fetchMemos(q);
    });

    document.addEventListener("DOMContentLoaded", () => {
      const token = localStorage.getItem("token");
      if (!token) {
        location.href = "/login";
      } else {
        fetchMemos();
      }
    });
  </script>
</body>
</html>
